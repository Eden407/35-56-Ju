import sys
import requests
from bs4 import BeautifulSoup
import urllib.parse

# ANSI color codes for terminal output
RED = "\033[31m"
GREEN = "\033[32m"
YELLOW = "\033[33m"
BLUE = "\033[34m"
RESET = "\033[0m"

def search_ios_app(app_name):
    query = urllib.parse.quote(app_name)
    # Build the search URL for the US App Store
    search_url = f"https://apps.apple.com/us/search?term={query}"
    headers = {"User-Agent": "Mozilla/5.0"}
    try:
        response = requests.get(search_url, headers=headers)
        response.raise_for_status()
    except Exception as e:
        print(f"{RED}[iOS] Error fetching search results: {e}{RESET}")
        return None

    soup = BeautifulSoup(response.text, "html.parser")
    # Find the first link that looks like an app detail page (pattern: /us/app/â€¦/id[digits])
    app_link = soup.find("a", href=lambda href: href and "/us/app/" in href and "/id" in href)
    if not app_link:
        print(f"{RED}[iOS] App '{app_name}' not found in search results.{RESET}")
        return None

    app_url = app_link.get("href")
    if not app_url.startswith("http"):
        app_url = "https://apps.apple.com" + app_url

    # Fetch the app's page
    try:
        response2 = requests.get(app_url, headers=headers)
        response2.raise_for_status()
    except Exception as e:
        print(f"{RED}[iOS] Error fetching app details: {e}{RESET}")
        return None

    soup2 = BeautifulSoup(response2.text, "html.parser")

    # Attempt to extract version info.
    # One strategy is to look for a list item (or similar) that starts with "Version"
    version = None
    for li in soup2.find_all("li"):
        text = li.get_text(strip=True)
        if text.startswith("Version"):
            version = text.replace("Version", "").strip()
            break
    if not version:
        version = "Version info not found"

    # Attempt to extract the "What's New" (release notes) section.
    # Many App Store pages include a section with aria-label "What's New"
    release_notes = None
    whats_new_section = soup2.find("section", attrs={"aria-label": "What's New"})
    if whats_new_section:
        p_elem = whats_new_section.find("p")
        if p_elem:
            release_notes = p_elem.get_text(strip=True)
    if not release_notes:
        release_notes = "Release notes not found"

    print(f"\n{BLUE}[iOS]{RESET}")
    print(f"{GREEN}App URL:{RESET} {app_url}")
    print(f"{YELLOW}Version:{RESET} {version}")
    print(f"{YELLOW}Release Notes:{RESET}\n{release_notes}")
    return True

def search_android_app(app_name):
    query = urllib.parse.quote(app_name)
    search_url = f"https://play.google.com/store/search?q={query}&c=apps&hl=en&gl=us"
    headers = {"User-Agent": "Mozilla/5.0"}
    try:
        r = requests.get(search_url, headers=headers)
        r.raise_for_status()
        soup = BeautifulSoup(r.text, "html.parser")
        # Find the first app detail link
        app_link = soup.select_one("a[href^='/store/apps/details?id=']")
        if not app_link:
            print(f"{RED}[Android] App '{app_name}' not found on Google Play.{RESET}")
            return None

        app_url = "https://play.google.com" + app_link["href"]
        r = requests.get(app_url, headers=headers)
        r.raise_for_status()
        soup = BeautifulSoup(r.text, "html.parser")
        
        title_tag = soup.find("h1", class_="AHFaub")
        title = title_tag.get_text(strip=True) if title_tag else "Unknown App"
        
        # "What's New" on Google Play is often within a div with class "W4P4ne"
        whats_new_section = soup.find("div", class_="W4P4ne")
        release_notes = whats_new_section.get_text(strip=True) if whats_new_section else "No release notes found."
        
        print(f"\n{BLUE}[Android]{RESET}")
        print(f"{GREEN}{title}{RESET}")
        print(f"{YELLOW}Release Notes:{RESET}\n{release_notes}")
    except Exception as e:
        print(f"{RED}[Android] Error fetching app details: {e}{RESET}")
        return None

def main():
    try:
        app_name = input(f"{YELLOW}Enter the app name to check: {RESET}").strip()
    except EOFError:
        sys.exit(f"{RED}No input provided. Exiting.{RESET}")
    
    if not app_name:
        sys.exit(f"{RED}No app name provided. Exiting.{RESET}")
    
    print(f"\nFetching latest release info for '{app_name}'...")
    search_ios_app(app_name)
    search_android_app(app_name)

if __name__ == "__main__":
    main()
